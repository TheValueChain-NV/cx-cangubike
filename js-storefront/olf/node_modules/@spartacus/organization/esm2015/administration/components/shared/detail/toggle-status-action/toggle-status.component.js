import { Component, Input } from '@angular/core';
import { LoadStatus } from '@spartacus/organization/administration/core';
import { Subscription } from 'rxjs';
import { filter, first, take } from 'rxjs/operators';
import { ConfirmationMessageComponent } from '../../message/confirmation/confirmation-message.component';
import * as i0 from "@angular/core";
import * as i1 from "../../item.service";
import * as i2 from "../../message/services/message.service";
import * as i3 from "../disable-info/disable-info.service";
import * as i4 from "@angular/common";
import * as i5 from "@spartacus/core";
/**
 * Reusable component in the my-company is to toggle the disabled state for
 * my company entities.
 */
export class ToggleStatusComponent {
    constructor(itemService, messageService, disableInfoService) {
        this.itemService = itemService;
        this.messageService = messageService;
        this.disableInfoService = disableInfoService;
        /**
         * The key input can be used to add a custom key.
         *
         * Most _organization_ entities use the `code` key, but there is some variations.
         */
        this.key = 'code';
        /**
         * resolves the current item.
         */
        this.current$ = this.itemService.current$;
        /**
         * resolves if the user is currently in the edit form.
         */
        this.isInEditMode$ = this.itemService.isInEditMode$;
        this.subscription = new Subscription();
    }
    toggle(item) {
        if (!item.active) {
            // we do ask for confirmation when the entity gets activated
            this.update(item);
        }
        else {
            if (!this.confirmation) {
                this.confirmation = this.messageService.add({
                    message: {
                        key: this.i18nRoot + '.messages.deactivate',
                        params: { item },
                    },
                    messageTitle: {
                        key: this.i18nRoot + '.messages.deactivateTitle',
                        params: { item },
                    },
                    confirm: {
                        key: 'organization.confirmation.disable',
                    },
                    component: ConfirmationMessageComponent,
                });
                this.subscription.add(this.confirmation.pipe(first()).subscribe((event) => {
                    if (event.close) {
                        this.confirmation = null;
                    }
                    if (event.confirm) {
                        this.messageService.close(this.confirmation);
                        this.update(item);
                        this.confirmation = null;
                    }
                }));
            }
        }
    }
    /**
     * Indicates whether the status can be toggled or not.
     */
    isDisabled(item) {
        var _a;
        return ((_a = this.disabled) !== null && _a !== void 0 ? _a : (this.disableInfoService.isParentDisabled(item) ||
            this.disableInfoService.isRootUnit(item)));
    }
    update(item) {
        this.itemService
            .update(item[this.key], this.getPatchedItem(item))
            .pipe(take(1), filter((data) => data.status === LoadStatus.SUCCESS))
            .subscribe((data) => this.notify(Object.assign(Object.assign({}, item), data.item)));
    }
    getPatchedItem(item) {
        const patch = {};
        patch[this.key] = item[this.key];
        patch.active = !item.active;
        return patch;
    }
    notify(item) {
        this.messageService.add({
            message: {
                key: `${this.i18nRoot}.messages.${item.active ? 'confirmEnabled' : 'confirmDisabled'}`,
                params: { item },
            },
        });
    }
    ngOnDestroy() {
        var _a;
        (_a = this.subscription) === null || _a === void 0 ? void 0 : _a.unsubscribe();
    }
}
ToggleStatusComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.0.5", ngImport: i0, type: ToggleStatusComponent, deps: [{ token: i1.ItemService }, { token: i2.MessageService }, { token: i3.DisableInfoService }], target: i0.ɵɵFactoryTarget.Component });
ToggleStatusComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "12.0.5", type: ToggleStatusComponent, selector: "cx-org-toggle-status", inputs: { i18nRoot: "i18nRoot", key: "key", disabled: "disabled" }, host: { classAttribute: "content-wrapper" }, ngImport: i0, template: "<button\n  *ngIf=\"current$ | async as item\"\n  class=\"button active\"\n  [disabled]=\"\n    isDisabled(item) ||\n    ((isInEditMode$ | async) && item.active && disabled !== true)\n  \"\n  (click)=\"toggle(item)\"\n>\n  {{ 'organization.' + (item.active ? 'disable' : 'enable') | cxTranslate }}\n</button>\n", directives: [{ type: i4.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }], pipes: { "async": i4.AsyncPipe, "cxTranslate": i5.TranslatePipe } });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.0.5", ngImport: i0, type: ToggleStatusComponent, decorators: [{
            type: Component,
            args: [{
                    selector: 'cx-org-toggle-status',
                    templateUrl: './toggle-status.component.html',
                    host: { class: 'content-wrapper' },
                }]
        }], ctorParameters: function () { return [{ type: i1.ItemService }, { type: i2.MessageService }, { type: i3.DisableInfoService }]; }, propDecorators: { i18nRoot: [{
                type: Input
            }], key: [{
                type: Input
            }], disabled: [{
                type: Input
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9nZ2xlLXN0YXR1cy5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9mZWF0dXJlLWxpYnMvb3JnYW5pemF0aW9uL2FkbWluaXN0cmF0aW9uL2NvbXBvbmVudHMvc2hhcmVkL2RldGFpbC90b2dnbGUtc3RhdHVzLWFjdGlvbi90b2dnbGUtc3RhdHVzLmNvbXBvbmVudC50cyIsIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL2ZlYXR1cmUtbGlicy9vcmdhbml6YXRpb24vYWRtaW5pc3RyYXRpb24vY29tcG9uZW50cy9zaGFyZWQvZGV0YWlsL3RvZ2dsZS1zdGF0dXMtYWN0aW9uL3RvZ2dsZS1zdGF0dXMuY29tcG9uZW50Lmh0bWwiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQWEsTUFBTSxlQUFlLENBQUM7QUFDNUQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLDZDQUE2QyxDQUFDO0FBQ3pFLE9BQU8sRUFBdUIsWUFBWSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3pELE9BQU8sRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXJELE9BQU8sRUFBRSw0QkFBNEIsRUFBRSxNQUFNLDJEQUEyRCxDQUFDOzs7Ozs7O0FBTXpHOzs7R0FHRztBQU1ILE1BQU0sT0FBTyxxQkFBcUI7SUFrQ2hDLFlBQ1ksV0FBMkIsRUFDM0IsY0FBdUQsRUFDdkQsa0JBQXlDO1FBRnpDLGdCQUFXLEdBQVgsV0FBVyxDQUFnQjtRQUMzQixtQkFBYyxHQUFkLGNBQWMsQ0FBeUM7UUFDdkQsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUF1QjtRQTVCckQ7Ozs7V0FJRztRQUNNLFFBQUcsR0FBRyxNQUFNLENBQUM7UUFPdEI7O1dBRUc7UUFDSCxhQUFRLEdBQWtCLElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDO1FBRXBE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O1FBQ3RCLElBQUksQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDO1lBQ3RCLE9BQU8sRUFBRTtnQkFDUCxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsUUFBUSxhQUNuQixJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsaUJBQ25DLEVBQUU7Z0JBQ0YsTUFBTSxFQUFFLEVBQUUsSUFBSSxFQUFFO2FBQ2pCO1NBQ0YsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELFdBQVc7O1FBQ1QsTUFBQSxJQUFJLENBQUMsWUFBWSwwQ0FBRSxXQUFXLEVBQUUsQ0FBQztJQUNuQyxDQUFDOztrSEF0SFUscUJBQXFCO3NHQUFyQixxQkFBcUIsNktDcEJsQyx1VEFXQTsyRkRTYSxxQkFBcUI7a0JBTGpDLFNBQVM7bUJBQUM7b0JBQ1QsUUFBUSxFQUFFLHNCQUFzQjtvQkFDaEMsV0FBVyxFQUFFLGdDQUFnQztvQkFDN0MsSUFBSSxFQUFFLEVBQUUsS0FBSyxFQUFFLGlCQUFpQixFQUFFO2lCQUNuQztnS0FRVSxRQUFRO3NCQUFoQixLQUFLO2dCQU9HLEdBQUc7c0JBQVgsS0FBSztnQkFLRyxRQUFRO3NCQUFoQixLQUFLIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBJbnB1dCwgT25EZXN0cm95IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBMb2FkU3RhdHVzIH0gZnJvbSAnQHNwYXJ0YWN1cy9vcmdhbml6YXRpb24vYWRtaW5pc3RyYXRpb24vY29yZSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJqZWN0LCBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGZpbHRlciwgZmlyc3QsIHRha2UgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBJdGVtU2VydmljZSB9IGZyb20gJy4uLy4uL2l0ZW0uc2VydmljZSc7XG5pbXBvcnQgeyBDb25maXJtYXRpb25NZXNzYWdlQ29tcG9uZW50IH0gZnJvbSAnLi4vLi4vbWVzc2FnZS9jb25maXJtYXRpb24vY29uZmlybWF0aW9uLW1lc3NhZ2UuY29tcG9uZW50JztcbmltcG9ydCB7IENvbmZpcm1hdGlvbk1lc3NhZ2VEYXRhIH0gZnJvbSAnLi4vLi4vbWVzc2FnZS9jb25maXJtYXRpb24vY29uZmlybWF0aW9uLW1lc3NhZ2UubW9kZWwnO1xuaW1wb3J0IHsgTWVzc2FnZVNlcnZpY2UgfSBmcm9tICcuLi8uLi9tZXNzYWdlL3NlcnZpY2VzL21lc3NhZ2Uuc2VydmljZSc7XG5pbXBvcnQgeyBCYXNlSXRlbSB9IGZyb20gJy4uLy4uL29yZ2FuaXphdGlvbi5tb2RlbCc7XG5pbXBvcnQgeyBEaXNhYmxlSW5mb1NlcnZpY2UgfSBmcm9tICcuLi9kaXNhYmxlLWluZm8vZGlzYWJsZS1pbmZvLnNlcnZpY2UnO1xuXG4vKipcbiAqIFJldXNhYmxlIGNvbXBvbmVudCBpbiB0aGUgbXktY29tcGFueSBpcyB0byB0b2dnbGUgdGhlIGRpc2FibGVkIHN0YXRlIGZvclxuICogbXkgY29tcGFueSBlbnRpdGllcy5cbiAqL1xuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnY3gtb3JnLXRvZ2dsZS1zdGF0dXMnLFxuICB0ZW1wbGF0ZVVybDogJy4vdG9nZ2xlLXN0YXR1cy5jb21wb25lbnQuaHRtbCcsXG4gIGhvc3Q6IHsgY2xhc3M6ICdjb250ZW50LXdyYXBwZXInIH0sXG59KVxuZXhwb3J0IGNsYXNzIFRvZ2dsZVN0YXR1c0NvbXBvbmVudDxUIGV4dGVuZHMgQmFzZUl0ZW0+IGltcGxlbWVudHMgT25EZXN0cm95IHtcbiAgLyoqXG4gICAqIFRoZSBsb2NhbGl6YXRpb24gb2YgbWVzc2FnZXMgaXMgYmFzZWQgb24gdGhlIGkxOG4gcm9vdC4gTWVzc2FnZXMgYXJlXG4gICAqIGNvbmNhdGVuYXRlZCB0byB0aGUgcm9vdCwgc3VjaCBhczpcbiAgICpcbiAgICogYFtpMThuUm9vdF0ubWVzc2FnZXMuZGVhY3RpdmF0ZWBcbiAgICovXG4gIEBJbnB1dCgpIGkxOG5Sb290OiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFRoZSBrZXkgaW5wdXQgY2FuIGJlIHVzZWQgdG8gYWRkIGEgY3VzdG9tIGtleS5cbiAgICpcbiAgICogTW9zdCBfb3JnYW5pemF0aW9uXyBlbnRpdGllcyB1c2UgdGhlIGBjb2RlYCBrZXksIGJ1dCB0aGVyZSBpcyBzb21lIHZhcmlhdGlvbnMuXG4gICAqL1xuICBASW5wdXQoKSBrZXkgPSAnY29kZSc7XG5cbiAgLyoqXG4gICAqIFRoZSBkaXNhYmxlZCBzdGF0ZSBpcyBjYWxjdWxhdGVkIGJ1dCBjYW4gYmUgcHJvdmlkZWQgYXMgd2VsbC5cbiAgICovXG4gIEBJbnB1dCgpIGRpc2FibGVkOiBib29sZWFuO1xuXG4gIC8qKlxuICAgKiByZXNvbHZlcyB0aGUgY3VycmVudCBpdGVtLlxuICAgKi9cbiAgY3VycmVudCQ6IE9ic2VydmFibGU8VD4gPSB0aGlzLml0ZW1TZXJ2aWNlLmN1cnJlbnQkO1xuXG4gIC8qKlxuICAgKiByZXNvbHZlcyBpZiB0aGUgdXNlciBpcyBjdXJyZW50bHkgaW4gdGhlIGVkaXQgZm9ybS5cbiAgICovXG4gIGlzSW5FZGl0TW9kZSQ6IE9ic2VydmFibGU8Ym9vbGVhbj4gPSB0aGlzLml0ZW1TZXJ2aWNlLmlzSW5FZGl0TW9kZSQ7XG5cbiAgcHJvdGVjdGVkIHN1YnNjcmlwdGlvbiA9IG5ldyBTdWJzY3JpcHRpb24oKTtcbiAgcHJvdGVjdGVkIGNvbmZpcm1hdGlvbjogU3ViamVjdDxDb25maXJtYXRpb25NZXNzYWdlRGF0YT47XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJvdGVjdGVkIGl0ZW1TZXJ2aWNlOiBJdGVtU2VydmljZTxUPixcbiAgICBwcm90ZWN0ZWQgbWVzc2FnZVNlcnZpY2U6IE1lc3NhZ2VTZXJ2aWNlPENvbmZpcm1hdGlvbk1lc3NhZ2VEYXRhPixcbiAgICBwcm90ZWN0ZWQgZGlzYWJsZUluZm9TZXJ2aWNlOiBEaXNhYmxlSW5mb1NlcnZpY2U8VD5cbiAgKSB7fVxuXG4gIHRvZ2dsZShpdGVtOiBUKSB7XG4gICAgaWYgKCFpdGVtLmFjdGl2ZSkge1xuICAgICAgLy8gd2UgZG8gYXNrIGZvciBjb25maXJtYXRpb24gd2hlbiB0aGUgZW50aXR5IGdldHMgYWN0aXZhdGVkXG4gICAgICB0aGlzLnVwZGF0ZShpdGVtKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKCF0aGlzLmNvbmZpcm1hdGlvbikge1xuICAgICAgICB0aGlzLmNvbmZpcm1hdGlvbiA9IHRoaXMubWVzc2FnZVNlcnZpY2UuYWRkKHtcbiAgICAgICAgICBtZXNzYWdlOiB7XG4gICAgICAgICAgICBrZXk6IHRoaXMuaTE4blJvb3QgKyAnLm1lc3NhZ2VzLmRlYWN0aXZhdGUnLFxuICAgICAgICAgICAgcGFyYW1zOiB7IGl0ZW0gfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIG1lc3NhZ2VUaXRsZToge1xuICAgICAgICAgICAga2V5OiB0aGlzLmkxOG5Sb290ICsgJy5tZXNzYWdlcy5kZWFjdGl2YXRlVGl0bGUnLFxuICAgICAgICAgICAgcGFyYW1zOiB7IGl0ZW0gfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIGNvbmZpcm06IHtcbiAgICAgICAgICAgIGtleTogJ29yZ2FuaXphdGlvbi5jb25maXJtYXRpb24uZGlzYWJsZScsXG4gICAgICAgICAgfSxcbiAgICAgICAgICBjb21wb25lbnQ6IENvbmZpcm1hdGlvbk1lc3NhZ2VDb21wb25lbnQsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuc3Vic2NyaXB0aW9uLmFkZChcbiAgICAgICAgICB0aGlzLmNvbmZpcm1hdGlvbi5waXBlKGZpcnN0KCkpLnN1YnNjcmliZSgoZXZlbnQpID0+IHtcbiAgICAgICAgICAgIGlmIChldmVudC5jbG9zZSkge1xuICAgICAgICAgICAgICB0aGlzLmNvbmZpcm1hdGlvbiA9IG51bGw7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoZXZlbnQuY29uZmlybSkge1xuICAgICAgICAgICAgICB0aGlzLm1lc3NhZ2VTZXJ2aWNlLmNsb3NlKHRoaXMuY29uZmlybWF0aW9uKTtcbiAgICAgICAgICAgICAgdGhpcy51cGRhdGUoaXRlbSk7XG4gICAgICAgICAgICAgIHRoaXMuY29uZmlybWF0aW9uID0gbnVsbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBJbmRpY2F0ZXMgd2hldGhlciB0aGUgc3RhdHVzIGNhbiBiZSB0b2dnbGVkIG9yIG5vdC5cbiAgICovXG4gIGlzRGlzYWJsZWQoaXRlbTogVCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiAoXG4gICAgICB0aGlzLmRpc2FibGVkID8/XG4gICAgICAodGhpcy5kaXNhYmxlSW5mb1NlcnZpY2UuaXNQYXJlbnREaXNhYmxlZChpdGVtKSB8fFxuICAgICAgICB0aGlzLmRpc2FibGVJbmZvU2VydmljZS5pc1Jvb3RVbml0KGl0ZW0pKVxuICAgICk7XG4gIH1cblxuICBwcm90ZWN0ZWQgdXBkYXRlKGl0ZW06IFQpOiB2b2lkIHtcbiAgICB0aGlzLml0ZW1TZXJ2aWNlXG4gICAgICAudXBkYXRlKGl0ZW1bdGhpcy5rZXldLCB0aGlzLmdldFBhdGNoZWRJdGVtKGl0ZW0pKVxuICAgICAgLnBpcGUoXG4gICAgICAgIHRha2UoMSksXG4gICAgICAgIGZpbHRlcigoZGF0YSkgPT4gZGF0YS5zdGF0dXMgPT09IExvYWRTdGF0dXMuU1VDQ0VTUylcbiAgICAgIClcbiAgICAgIC5zdWJzY3JpYmUoKGRhdGEpID0+IHRoaXMubm90aWZ5KHsgLi4uaXRlbSwgLi4uZGF0YS5pdGVtIH0pKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBnZXRQYXRjaGVkSXRlbShpdGVtOiBUKTogVCB7XG4gICAgY29uc3QgcGF0Y2g6IEJhc2VJdGVtID0ge307XG4gICAgcGF0Y2hbdGhpcy5rZXldID0gaXRlbVt0aGlzLmtleV07XG4gICAgcGF0Y2guYWN0aXZlID0gIWl0ZW0uYWN0aXZlO1xuICAgIHJldHVybiBwYXRjaCBhcyBUO1xuICB9XG5cbiAgcHJvdGVjdGVkIG5vdGlmeShpdGVtOiBUKSB7XG4gICAgdGhpcy5tZXNzYWdlU2VydmljZS5hZGQoe1xuICAgICAgbWVzc2FnZToge1xuICAgICAgICBrZXk6IGAke3RoaXMuaTE4blJvb3R9Lm1lc3NhZ2VzLiR7XG4gICAgICAgICAgaXRlbS5hY3RpdmUgPyAnY29uZmlybUVuYWJsZWQnIDogJ2NvbmZpcm1EaXNhYmxlZCdcbiAgICAgICAgfWAsXG4gICAgICAgIHBhcmFtczogeyBpdGVtIH0sXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy5zdWJzY3JpcHRpb24/LnVuc3Vic2NyaWJlKCk7XG4gIH1cbn1cbiIsIjxidXR0b25cbiAgKm5nSWY9XCJjdXJyZW50JCB8IGFzeW5jIGFzIGl0ZW1cIlxuICBjbGFzcz1cImJ1dHRvbiBhY3RpdmVcIlxuICBbZGlzYWJsZWRdPVwiXG4gICAgaXNEaXNhYmxlZChpdGVtKSB8fFxuICAgICgoaXNJbkVkaXRNb2RlJCB8IGFzeW5jKSAmJiBpdGVtLmFjdGl2ZSAmJiBkaXNhYmxlZCAhPT0gdHJ1ZSlcbiAgXCJcbiAgKGNsaWNrKT1cInRvZ2dsZShpdGVtKVwiXG4+XG4gIHt7ICdvcmdhbml6YXRpb24uJyArIChpdGVtLmFjdGl2ZSA/ICdkaXNhYmxlJyA6ICdlbmFibGUnKSB8IGN4VHJhbnNsYXRlIH19XG48L2J1dHRvbj5cbiJdfQ==