import { Injectable } from '@angular/core';
import { FormControl, FormGroup, Validators } from '@angular/forms';
import { CustomFormValidators } from '@spartacus/storefront';
import { Subscription } from 'rxjs';
import { distinctUntilChanged, filter } from 'rxjs/operators';
import { FormService } from '../../shared/form/form.service';
import * as i0 from "@angular/core";
export var PermissionType;
(function (PermissionType) {
    PermissionType["ORDER"] = "B2BOrderThresholdPermission";
    PermissionType["TIME_SPAN"] = "B2BOrderThresholdTimespanPermission";
    PermissionType["EXCEEDED"] = "B2BBudgetExceededPermission";
})(PermissionType || (PermissionType = {}));
export class PermissionFormService extends FormService {
    constructor() {
        super(...arguments);
        this.subscription = new Subscription();
    }
    /**
     * @override
     * Builds a generic sub form for permissions and amends the form
     * based on the for approval permission type.
     */
    build() {
        const form = new FormGroup({});
        form.setControl('code', new FormControl('', [
            Validators.required,
            CustomFormValidators.noSpecialCharacters,
        ]));
        form.setControl('orgUnit', new FormGroup({
            uid: new FormControl(undefined, Validators.required),
        }));
        form.setControl('orderApprovalPermissionType', new FormGroup({
            code: new FormControl(undefined, Validators.required),
        }));
        // subscribe to permission type changes and amend accordingly.
        this.subscription.add(form
            .get('orderApprovalPermissionType')
            .get('code')
            .valueChanges.pipe(distinctUntilChanged(), filter((code) => !!code))
            .subscribe((code) => this.amend(form, code)));
        this.form = form;
    }
    /**
     * @override
     * The form is using  `B2BBudgetExceededPermission` by default.
     */
    get defaultValue() {
        return {
            orderApprovalPermissionType: {
                code: PermissionType.EXCEEDED,
            },
        };
    }
    /**
     * Amends the form structure based on the `PermissionType`.
     */
    amend(form, code) {
        if (code === PermissionType.EXCEEDED) {
            form.removeControl('periodRange');
            form.removeControl('currency');
            form.removeControl('threshold');
        }
        if (code === PermissionType.TIME_SPAN || code === PermissionType.ORDER) {
            if (!form.get('currency')) {
                form.setControl('currency', new FormGroup({
                    isocode: new FormControl(undefined, Validators.required),
                }));
            }
            if (!form.get('threshold')) {
                form.setControl('threshold', new FormControl('', Validators.required));
            }
        }
        if (code === PermissionType.ORDER) {
            form.removeControl('periodRange');
        }
        if (code === PermissionType.TIME_SPAN) {
            if (!form.get('periodRange')) {
                form.setControl('periodRange', new FormControl('', Validators.required));
            }
        }
    }
    ngOnDestroy() {
        this.subscription.unsubscribe();
    }
    patchData(item) {
        super.patchData(item);
        if ((item === null || item === void 0 ? void 0 : item.code) !== undefined) {
            this.form.get('orderApprovalPermissionType').disable();
        }
    }
}
PermissionFormService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.0.5", ngImport: i0, type: PermissionFormService, deps: null, target: i0.ɵɵFactoryTarget.Injectable });
PermissionFormService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "12.0.5", ngImport: i0, type: PermissionFormService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.0.5", ngImport: i0, type: PermissionFormService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVybWlzc2lvbi1mb3JtLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9mZWF0dXJlLWxpYnMvb3JnYW5pemF0aW9uL2FkbWluaXN0cmF0aW9uL2NvbXBvbmVudHMvcGVybWlzc2lvbi9mb3JtL3Blcm1pc3Npb24tZm9ybS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQWEsTUFBTSxlQUFlLENBQUM7QUFDdEQsT0FBTyxFQUFFLFdBQVcsRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFcEUsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDN0QsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNwQyxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDOUQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGdDQUFnQyxDQUFDOztBQUU3RCxNQUFNLENBQU4sSUFBWSxjQUlYO0FBSkQsV0FBWSxjQUFjO0lBQ3hCLHVEQUFxQyxDQUFBO0lBQ3JDLG1FQUFpRCxDQUFBO0lBQ2pELDBEQUF3QyxDQUFBO0FBQzFDLENBQUMsRUFKVyxjQUFjLEtBQWQsY0FBYyxRQUl6QjtBQUlELE1BQU0sT0FBTyxxQkFDWCxTQUFRLFdBQXVCO0lBSmpDOztRQU9ZLGlCQUFZLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztLQXlHN0M7SUF2R0M7Ozs7T0FJRztJQUNPLEtBQUs7UUFDYixNQUFNLElBQUksR0FBRyxJQUFJLFNBQVMsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUMvQixJQUFJLENBQUMsVUFBVSxDQUNiLE1BQU0sRUFDTixJQUFJLFdBQVcsQ0FBQyxFQUFFLEVBQUU7WUFDbEIsVUFBVSxDQUFDLFFBQVE7WUFDbkIsb0JBQW9CLENBQUMsbUJBQW1CO1NBQ3pDLENBQUMsQ0FDSCxDQUFDO1FBQ0YsSUFBSSxDQUFDLFVBQVUsQ0FDYixTQUFTLEVBQ1QsSUFBSSxTQUFTLENBQUM7WUFDWixHQUFHLEVBQUUsSUFBSSxXQUFXLENBQUMsU0FBUyxFQUFFLFVBQVUsQ0FBQyxRQUFRLENBQUM7U0FDckQsQ0FBQyxDQUNILENBQUM7UUFFRixJQUFJLENBQUMsVUFBVSxDQUNiLDZCQUE2QixFQUM3QixJQUFJLFNBQVMsQ0FBQztZQUNaLElBQUksRUFBRSxJQUFJLFdBQVcsQ0FBQyxTQUFTLEVBQUUsVUFBVSxDQUFDLFFBQVEsQ0FBQztTQUN0RCxDQUFDLENBQ0gsQ0FBQztRQUVGLDhEQUE4RDtRQUM5RCxJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FDbkIsSUFBSTthQUNELEdBQUcsQ0FBQyw2QkFBNkIsQ0FBQzthQUNsQyxHQUFHLENBQUMsTUFBTSxDQUFDO2FBQ1gsWUFBWSxDQUFDLElBQUksQ0FDaEIsb0JBQW9CLEVBQUUsRUFDdEIsTUFBTSxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQ3pCO2FBQ0EsU0FBUyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUMvQyxDQUFDO1FBRUYsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7SUFDbkIsQ0FBQztJQUVEOzs7T0FHRztJQUNILElBQUksWUFBWTtRQUNkLE9BQU87WUFDTCwyQkFBMkIsRUFBRTtnQkFDM0IsSUFBSSxFQUFFLGNBQWMsQ0FBQyxRQUFRO2FBQzlCO1NBQ0YsQ0FBQztJQUNKLENBQUM7SUFFRDs7T0FFRztJQUNPLEtBQUssQ0FBQyxJQUFlLEVBQUUsSUFBb0I7UUFDbkQsSUFBSSxJQUFJLEtBQUssY0FBYyxDQUFDLFFBQVEsRUFBRTtZQUNwQyxJQUFJLENBQUMsYUFBYSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1lBQ2xDLElBQUksQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDL0IsSUFBSSxDQUFDLGFBQWEsQ0FBQyxXQUFXLENBQUMsQ0FBQztTQUNqQztRQUVELElBQUksSUFBSSxLQUFLLGNBQWMsQ0FBQyxTQUFTLElBQUksSUFBSSxLQUFLLGNBQWMsQ0FBQyxLQUFLLEVBQUU7WUFDdEUsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLEVBQUU7Z0JBQ3pCLElBQUksQ0FBQyxVQUFVLENBQ2IsVUFBVSxFQUNWLElBQUksU0FBUyxDQUFDO29CQUNaLE9BQU8sRUFBRSxJQUFJLFdBQVcsQ0FBQyxTQUFTLEVBQUUsVUFBVSxDQUFDLFFBQVEsQ0FBQztpQkFDekQsQ0FBQyxDQUNILENBQUM7YUFDSDtZQUNELElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxFQUFFO2dCQUMxQixJQUFJLENBQUMsVUFBVSxDQUFDLFdBQVcsRUFBRSxJQUFJLFdBQVcsQ0FBQyxFQUFFLEVBQUUsVUFBVSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7YUFDeEU7U0FDRjtRQUVELElBQUksSUFBSSxLQUFLLGNBQWMsQ0FBQyxLQUFLLEVBQUU7WUFDakMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxhQUFhLENBQUMsQ0FBQztTQUNuQztRQUVELElBQUksSUFBSSxLQUFLLGNBQWMsQ0FBQyxTQUFTLEVBQUU7WUFDckMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLEVBQUU7Z0JBQzVCLElBQUksQ0FBQyxVQUFVLENBQ2IsYUFBYSxFQUNiLElBQUksV0FBVyxDQUFDLEVBQUUsRUFBRSxVQUFVLENBQUMsUUFBUSxDQUFDLENBQ3pDLENBQUM7YUFDSDtTQUNGO0lBQ0gsQ0FBQztJQUVELFdBQVc7UUFDVCxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ2xDLENBQUM7SUFFUyxTQUFTLENBQUMsSUFBSztRQUN2QixLQUFLLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3RCLElBQUksQ0FBQSxJQUFJLGFBQUosSUFBSSx1QkFBSixJQUFJLENBQUUsSUFBSSxNQUFLLFNBQVMsRUFBRTtZQUM1QixJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyw2QkFBNkIsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO1NBQ3hEO0lBQ0gsQ0FBQzs7a0hBNUdVLHFCQUFxQjtzSEFBckIscUJBQXFCLGNBRnBCLE1BQU07MkZBRVAscUJBQXFCO2tCQUhqQyxVQUFVO21CQUFDO29CQUNWLFVBQVUsRUFBRSxNQUFNO2lCQUNuQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIE9uRGVzdHJveSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgRm9ybUNvbnRyb2wsIEZvcm1Hcm91cCwgVmFsaWRhdG9ycyB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IFBlcm1pc3Npb24gfSBmcm9tICdAc3BhcnRhY3VzL29yZ2FuaXphdGlvbi9hZG1pbmlzdHJhdGlvbi9jb3JlJztcbmltcG9ydCB7IEN1c3RvbUZvcm1WYWxpZGF0b3JzIH0gZnJvbSAnQHNwYXJ0YWN1cy9zdG9yZWZyb250JztcbmltcG9ydCB7IFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZGlzdGluY3RVbnRpbENoYW5nZWQsIGZpbHRlciB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEZvcm1TZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc2hhcmVkL2Zvcm0vZm9ybS5zZXJ2aWNlJztcblxuZXhwb3J0IGVudW0gUGVybWlzc2lvblR5cGUge1xuICBPUkRFUiA9ICdCMkJPcmRlclRocmVzaG9sZFBlcm1pc3Npb24nLFxuICBUSU1FX1NQQU4gPSAnQjJCT3JkZXJUaHJlc2hvbGRUaW1lc3BhblBlcm1pc3Npb24nLFxuICBFWENFRURFRCA9ICdCMkJCdWRnZXRFeGNlZWRlZFBlcm1pc3Npb24nLFxufVxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCcsXG59KVxuZXhwb3J0IGNsYXNzIFBlcm1pc3Npb25Gb3JtU2VydmljZVxuICBleHRlbmRzIEZvcm1TZXJ2aWNlPFBlcm1pc3Npb24+XG4gIGltcGxlbWVudHMgT25EZXN0cm95XG57XG4gIHByb3RlY3RlZCBzdWJzY3JpcHRpb24gPSBuZXcgU3Vic2NyaXB0aW9uKCk7XG5cbiAgLyoqXG4gICAqIEBvdmVycmlkZVxuICAgKiBCdWlsZHMgYSBnZW5lcmljIHN1YiBmb3JtIGZvciBwZXJtaXNzaW9ucyBhbmQgYW1lbmRzIHRoZSBmb3JtXG4gICAqIGJhc2VkIG9uIHRoZSBmb3IgYXBwcm92YWwgcGVybWlzc2lvbiB0eXBlLlxuICAgKi9cbiAgcHJvdGVjdGVkIGJ1aWxkKCkge1xuICAgIGNvbnN0IGZvcm0gPSBuZXcgRm9ybUdyb3VwKHt9KTtcbiAgICBmb3JtLnNldENvbnRyb2woXG4gICAgICAnY29kZScsXG4gICAgICBuZXcgRm9ybUNvbnRyb2woJycsIFtcbiAgICAgICAgVmFsaWRhdG9ycy5yZXF1aXJlZCxcbiAgICAgICAgQ3VzdG9tRm9ybVZhbGlkYXRvcnMubm9TcGVjaWFsQ2hhcmFjdGVycyxcbiAgICAgIF0pXG4gICAgKTtcbiAgICBmb3JtLnNldENvbnRyb2woXG4gICAgICAnb3JnVW5pdCcsXG4gICAgICBuZXcgRm9ybUdyb3VwKHtcbiAgICAgICAgdWlkOiBuZXcgRm9ybUNvbnRyb2wodW5kZWZpbmVkLCBWYWxpZGF0b3JzLnJlcXVpcmVkKSxcbiAgICAgIH0pXG4gICAgKTtcblxuICAgIGZvcm0uc2V0Q29udHJvbChcbiAgICAgICdvcmRlckFwcHJvdmFsUGVybWlzc2lvblR5cGUnLFxuICAgICAgbmV3IEZvcm1Hcm91cCh7XG4gICAgICAgIGNvZGU6IG5ldyBGb3JtQ29udHJvbCh1bmRlZmluZWQsIFZhbGlkYXRvcnMucmVxdWlyZWQpLFxuICAgICAgfSlcbiAgICApO1xuXG4gICAgLy8gc3Vic2NyaWJlIHRvIHBlcm1pc3Npb24gdHlwZSBjaGFuZ2VzIGFuZCBhbWVuZCBhY2NvcmRpbmdseS5cbiAgICB0aGlzLnN1YnNjcmlwdGlvbi5hZGQoXG4gICAgICBmb3JtXG4gICAgICAgIC5nZXQoJ29yZGVyQXBwcm92YWxQZXJtaXNzaW9uVHlwZScpXG4gICAgICAgIC5nZXQoJ2NvZGUnKVxuICAgICAgICAudmFsdWVDaGFuZ2VzLnBpcGUoXG4gICAgICAgICAgZGlzdGluY3RVbnRpbENoYW5nZWQoKSxcbiAgICAgICAgICBmaWx0ZXIoKGNvZGUpID0+ICEhY29kZSlcbiAgICAgICAgKVxuICAgICAgICAuc3Vic2NyaWJlKChjb2RlKSA9PiB0aGlzLmFtZW5kKGZvcm0sIGNvZGUpKVxuICAgICk7XG5cbiAgICB0aGlzLmZvcm0gPSBmb3JtO1xuICB9XG5cbiAgLyoqXG4gICAqIEBvdmVycmlkZVxuICAgKiBUaGUgZm9ybSBpcyB1c2luZyAgYEIyQkJ1ZGdldEV4Y2VlZGVkUGVybWlzc2lvbmAgYnkgZGVmYXVsdC5cbiAgICovXG4gIGdldCBkZWZhdWx0VmFsdWUoKTogUGVybWlzc2lvbiB7XG4gICAgcmV0dXJuIHtcbiAgICAgIG9yZGVyQXBwcm92YWxQZXJtaXNzaW9uVHlwZToge1xuICAgICAgICBjb2RlOiBQZXJtaXNzaW9uVHlwZS5FWENFRURFRCxcbiAgICAgIH0sXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBbWVuZHMgdGhlIGZvcm0gc3RydWN0dXJlIGJhc2VkIG9uIHRoZSBgUGVybWlzc2lvblR5cGVgLlxuICAgKi9cbiAgcHJvdGVjdGVkIGFtZW5kKGZvcm06IEZvcm1Hcm91cCwgY29kZTogUGVybWlzc2lvblR5cGUpIHtcbiAgICBpZiAoY29kZSA9PT0gUGVybWlzc2lvblR5cGUuRVhDRUVERUQpIHtcbiAgICAgIGZvcm0ucmVtb3ZlQ29udHJvbCgncGVyaW9kUmFuZ2UnKTtcbiAgICAgIGZvcm0ucmVtb3ZlQ29udHJvbCgnY3VycmVuY3knKTtcbiAgICAgIGZvcm0ucmVtb3ZlQ29udHJvbCgndGhyZXNob2xkJyk7XG4gICAgfVxuXG4gICAgaWYgKGNvZGUgPT09IFBlcm1pc3Npb25UeXBlLlRJTUVfU1BBTiB8fCBjb2RlID09PSBQZXJtaXNzaW9uVHlwZS5PUkRFUikge1xuICAgICAgaWYgKCFmb3JtLmdldCgnY3VycmVuY3knKSkge1xuICAgICAgICBmb3JtLnNldENvbnRyb2woXG4gICAgICAgICAgJ2N1cnJlbmN5JyxcbiAgICAgICAgICBuZXcgRm9ybUdyb3VwKHtcbiAgICAgICAgICAgIGlzb2NvZGU6IG5ldyBGb3JtQ29udHJvbCh1bmRlZmluZWQsIFZhbGlkYXRvcnMucmVxdWlyZWQpLFxuICAgICAgICAgIH0pXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBpZiAoIWZvcm0uZ2V0KCd0aHJlc2hvbGQnKSkge1xuICAgICAgICBmb3JtLnNldENvbnRyb2woJ3RocmVzaG9sZCcsIG5ldyBGb3JtQ29udHJvbCgnJywgVmFsaWRhdG9ycy5yZXF1aXJlZCkpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChjb2RlID09PSBQZXJtaXNzaW9uVHlwZS5PUkRFUikge1xuICAgICAgZm9ybS5yZW1vdmVDb250cm9sKCdwZXJpb2RSYW5nZScpO1xuICAgIH1cblxuICAgIGlmIChjb2RlID09PSBQZXJtaXNzaW9uVHlwZS5USU1FX1NQQU4pIHtcbiAgICAgIGlmICghZm9ybS5nZXQoJ3BlcmlvZFJhbmdlJykpIHtcbiAgICAgICAgZm9ybS5zZXRDb250cm9sKFxuICAgICAgICAgICdwZXJpb2RSYW5nZScsXG4gICAgICAgICAgbmV3IEZvcm1Db250cm9sKCcnLCBWYWxpZGF0b3JzLnJlcXVpcmVkKVxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIHRoaXMuc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gIH1cblxuICBwcm90ZWN0ZWQgcGF0Y2hEYXRhKGl0ZW0/KSB7XG4gICAgc3VwZXIucGF0Y2hEYXRhKGl0ZW0pO1xuICAgIGlmIChpdGVtPy5jb2RlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHRoaXMuZm9ybS5nZXQoJ29yZGVyQXBwcm92YWxQZXJtaXNzaW9uVHlwZScpLmRpc2FibGUoKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==