import { __decorate } from "tslib";
import { Injectable } from '@angular/core';
import { Effect, ofType } from '@ngrx/effects';
import { normalizeHttpError, StateUtils, } from '@spartacus/core';
import { from, of } from 'rxjs';
import { catchError, map, switchMap } from 'rxjs/operators';
import { OrganizationActions, PermissionActions } from '../actions';
import * as i0 from "@angular/core";
import * as i1 from "@ngrx/effects";
import * as i2 from "../../connectors/permission/permission.connector";
export class PermissionEffects {
    constructor(actions$, permissionConnector) {
        this.actions$ = actions$;
        this.permissionConnector = permissionConnector;
        this.loadPermission$ = this.actions$.pipe(ofType(PermissionActions.LOAD_PERMISSION), map((action) => action.payload), switchMap(({ userId, permissionCode }) => {
            return this.permissionConnector.get(userId, permissionCode).pipe(map((permission) => {
                return new PermissionActions.LoadPermissionSuccess([permission]);
            }), catchError((error) => of(new PermissionActions.LoadPermissionFail({
                permissionCode,
                error: normalizeHttpError(error),
            }))));
        }));
        this.loadPermissions$ = this.actions$.pipe(ofType(PermissionActions.LOAD_PERMISSIONS), map((action) => action.payload), switchMap((payload) => this.permissionConnector.getList(payload.userId, payload.params).pipe(switchMap((permissions) => {
            const { values, page } = StateUtils.normalizeListPage(permissions, 'code');
            return [
                new PermissionActions.LoadPermissionSuccess(values),
                new PermissionActions.LoadPermissionsSuccess({
                    page,
                    params: payload.params,
                }),
            ];
        }), catchError((error) => of(new PermissionActions.LoadPermissionsFail({
            params: payload.params,
            error: normalizeHttpError(error),
        }))))));
        this.createPermission$ = this.actions$.pipe(ofType(PermissionActions.CREATE_PERMISSION), map((action) => action.payload), switchMap((payload) => this.permissionConnector.create(payload.userId, payload.permission).pipe(switchMap((data) => [
            new PermissionActions.CreatePermissionSuccess(data),
            new OrganizationActions.OrganizationClearData(),
        ]), catchError((error) => from([
            new PermissionActions.CreatePermissionFail({
                permissionCode: payload.permission.code,
                error: normalizeHttpError(error),
            }),
            new OrganizationActions.OrganizationClearData(),
        ])))));
        this.updatePermission$ = this.actions$.pipe(ofType(PermissionActions.UPDATE_PERMISSION), map((action) => action.payload), switchMap((payload) => this.permissionConnector
            .update(payload.userId, payload.permissionCode, payload.permission)
            .pipe(switchMap((data) => [
            new PermissionActions.UpdatePermissionSuccess(data),
            new OrganizationActions.OrganizationClearData(),
        ]), catchError((error) => from([
            new PermissionActions.UpdatePermissionFail({
                permissionCode: payload.permission.code,
                error: normalizeHttpError(error),
            }),
            new OrganizationActions.OrganizationClearData(),
        ])))));
        this.loadPermissionTypes$ = this.actions$.pipe(ofType(PermissionActions.LOAD_PERMISSION_TYPES), switchMap(() => this.permissionConnector.getTypes().pipe(map((permissionTypeList) => new PermissionActions.LoadPermissionTypesSuccess(permissionTypeList)), catchError((error) => of(new PermissionActions.LoadPermissionTypesFail({
            error: normalizeHttpError(error),
        }))))));
    }
}
PermissionEffects.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.0.5", ngImport: i0, type: PermissionEffects, deps: [{ token: i1.Actions }, { token: i2.PermissionConnector }], target: i0.ɵɵFactoryTarget.Injectable });
PermissionEffects.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "12.0.5", ngImport: i0, type: PermissionEffects });
__decorate([
    Effect()
], PermissionEffects.prototype, "loadPermission$", void 0);
__decorate([
    Effect()
], PermissionEffects.prototype, "loadPermissions$", void 0);
__decorate([
    Effect()
], PermissionEffects.prototype, "createPermission$", void 0);
__decorate([
    Effect()
], PermissionEffects.prototype, "updatePermission$", void 0);
__decorate([
    Effect()
], PermissionEffects.prototype, "loadPermissionTypes$", void 0);
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.0.5", ngImport: i0, type: PermissionEffects, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.Actions }, { type: i2.PermissionConnector }]; }, propDecorators: { loadPermission$: [], loadPermissions$: [], createPermission$: [], updatePermission$: [], loadPermissionTypes$: [] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVybWlzc2lvbi5lZmZlY3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9mZWF0dXJlLWxpYnMvb3JnYW5pemF0aW9uL2FkbWluaXN0cmF0aW9uL2NvcmUvc3RvcmUvZWZmZWN0cy9wZXJtaXNzaW9uLmVmZmVjdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQ0EsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQVcsTUFBTSxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN4RCxPQUFPLEVBRUwsa0JBQWtCLEVBRWxCLFVBQVUsR0FDWCxNQUFNLGlCQUFpQixDQUFDO0FBQ3pCLE9BQU8sRUFBRSxJQUFJLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzVDLE9BQU8sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRzVELE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxpQkFBaUIsRUFBRSxNQUFNLFlBQVksQ0FBQzs7OztBQUdwRSxNQUFNLE9BQU8saUJBQWlCO0lBMkk1QixZQUNVLFFBQWlCLEVBQ2pCLG1CQUF3QztRQUR4QyxhQUFRLEdBQVIsUUFBUSxDQUFTO1FBQ2pCLHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBcUI7UUEzSWxELG9CQUFlLEdBR1gsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQ3BCLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxlQUFlLENBQUMsRUFDekMsR0FBRyxDQUFDLENBQUMsTUFBd0MsRUFBRSxFQUFFLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxFQUNqRSxTQUFTLENBQUMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxjQUFjLEVBQUUsRUFBRSxFQUFFO1lBQ3ZDLE9BQU8sSUFBSSxDQUFDLG1CQUFtQixDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsY0FBYyxDQUFDLENBQUMsSUFB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QXVCLENBQUM7WUFDNUMsS0FBSyxFQUFFLGtCQUFrQixDQUFDLEtBQUssQ0FBQztTQUNqQyxDQUFDLENBQ0gsQ0FDRixDQUNGLENBQ0YsQ0FDRixDQUFDO0lBS0MsQ0FBQzs7OEdBOUlPLGlCQUFpQjtrSEFBakIsaUJBQWlCO0FBRTVCO0lBREMsTUFBTSxFQUFFOzBEQXNCUDtBQUdGO0lBREMsTUFBTSxFQUFFOzJEQWlDUDtBQUdGO0lBREMsTUFBTSxFQUFFOzREQXlCUDtBQUdGO0lBREMsTUFBTSxFQUFFOzREQTJCUDtBQUdGO0lBREMsTUFBTSxFQUFFOytEQXFCUDsyRkF6SVMsaUJBQWlCO2tCQUQ3QixVQUFVO2dJQUdULGVBQWUsTUF3QmYsZ0JBQWdCLE1BbUNoQixpQkFBaUIsTUEyQmpCLGlCQUFpQixNQTZCakIsb0JBQW9CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSHR0cEVycm9yUmVzcG9uc2UgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBY3Rpb25zLCBFZmZlY3QsIG9mVHlwZSB9IGZyb20gJ0BuZ3J4L2VmZmVjdHMnO1xuaW1wb3J0IHtcbiAgRW50aXRpZXNNb2RlbCxcbiAgbm9ybWFsaXplSHR0cEVycm9yLFxuICBPcmRlckFwcHJvdmFsUGVybWlzc2lvblR5cGUsXG4gIFN0YXRlVXRpbHMsXG59IGZyb20gJ0BzcGFydGFjdXMvY29yZSc7XG5pbXBvcnQgeyBmcm9tLCBPYnNlcnZhYmxlLCBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgY2F0Y2hFcnJvciwgbWFwLCBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBQZXJtaXNzaW9uQ29ubmVjdG9yIH0gZnJvbSAnLi4vLi4vY29ubmVjdG9ycy9wZXJtaXNzaW9uL3Blcm1pc3Npb24uY29ubmVjdG9yJztcbmltcG9ydCB7IFBlcm1pc3Npb24gfSBmcm9tICcuLi8uLi9tb2RlbC9wZXJtaXNzaW9uLm1vZGVsJztcbmltcG9ydCB7IE9yZ2FuaXphdGlvbkFjdGlvbnMsIFBlcm1pc3Npb25BY3Rpb25zIH0gZnJvbSAnLi4vYWN0aW9ucyc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBQZXJtaXNzaW9uRWZmZWN0cyB7XG4gIEBFZmZlY3QoKVxuICBsb2FkUGVybWlzc2lvbiQ6IE9ic2VydmFibGU8XG4gICAgfCBQZXJtaXNzaW9uQWN0aW9ucy5Mb2FkUGVybWlzc2lvblN1Y2Nlc3NcbiAgICB8IFBlcm1pc3Npb25BY3Rpb25zLkxvYWRQZXJtaXNzaW9uRmFpbFxuICA+ID0gdGhpcy5hY3Rpb25zJC5waXBlKFxuICAgIG9mVHlwZShQZXJtaXNzaW9uQWN0aW9ucy5MT0FEX1BFUk1JU1NJT04pLFxuICAgIG1hcCgoYWN0aW9uOiBQZXJtaXNzaW9uQWN0aW9ucy5Mb2FkUGVybWlzc2lvbikgPT4gYWN0aW9uLnBheWxvYWQpLFxuICAgIHN3aXRjaE1hcCgoeyB1c2VySWQsIHBlcm1pc3Npb25Db2RlIH0pID0+IHtcbiAgICAgIHJldHVybiB0aGlzLnBlcm1pc3Npb25Db25uZWN0b3IuZ2V0KHVzZXJJZCwgcGVybWlzc2lvbkNvZGUpLnBpcGUoXG4gICAgICAgIG1hcCgocGVybWlzc2lvbjogUGVybWlzc2lvbikgPT4ge1xuICAgICAgICAgIHJldHVybiBuZXcgUGVybWlzc2lvbkFjdGlvbnMuTG9hZFBlcm1pc3Npb25TdWNjZXNzKFtwZXJtaXNzaW9uXSk7XG4gICAgICAgIH0pLFxuICAgICAgICBjYXRjaEVycm9yKChlcnJvcjogSHR0cEVycm9yUmVzcG9uc2UpID0+XG4gICAgICAgICAgb2YoXG4gICAgICAgICAgICBuZXcgUGVybWlzc2lvbkFjdGlvbnMuTG9hZFBlcm1pc3Npb25GYWlsKHtcbiAgICAgICAgICAgICAgcGVybWlzc2lvbkNvZGUsXG4gICAgICAgICAgICAgIGVycm9yOiBub3JtYWxpemVIdHRwRXJyb3IoZXJyb3IpLFxuICAgICAgICAgICAgfSlcbiAgICAgICAgICApXG4gICAgICAgIClcbiAgICAgICk7XG4gICAgfSlcbiAgKTtcblxuICBARWZmZWN0KClcbiAgbG9hZFBlcm1pc3Npb25zJDogT2JzZXJ2YWJsZTxcbiAgICB8IFBlcm1pc3Npb25BY3Rpb25zLkxvYWRQZXJtaXNzaW9uc1N1Y2Nlc3NcbiAgICB8IFBlcm1pc3Npb25BY3Rpb25zLkxvYWRQZXJtaXNzaW9uU3VjY2Vzc1xuICAgIHwgUGVybWlzc2lvbkFjdGlvbnMuTG9hZFBlcm1pc3Npb25zRmFpbFxuICA+ID0gdGhpcy5hY3Rpb25zJC5waXBlKFxuICAgIG9mVHlwZShQZXJtaXNzaW9uQWN0aW9ucy5MT0FEX1BFUk1JU1NJT05TKSxcbiAgICBtYXAoKGFjdGlvbjogUGVybWlzc2lvbkFjdGlvbnMuTG9hZFBlcm1pc3Npb25zKSA9PiBhY3Rpb24ucGF5bG9hZCksXG4gICAgc3dpdGNoTWFwKChwYXlsb2FkKSA9PlxuICAgICAgdGhpcy5wZXJtaXNzaW9uQ29ubmVjdG9yLmdldExpc3QocGF5bG9hZC51c2VySWQsIHBheWxvYWQucGFyYW1zKS5waXBlKFxuICAgICAgICBzd2l0Y2hNYXAoKHBlcm1pc3Npb25zOiBFbnRpdGllc01vZGVsPFBlcm1pc3Npb24+KSA9PiB7XG4gICAgICAgICAgY29uc3QgeyB2YWx1ZXMsIHBhZ2UgfSA9IFN0YXRlVXRpbHMubm9ybWFsaXplTGlzdFBhZ2UoXG4gICAgICAgICAgICBwZXJtaXNzaW9ucyxcbiAgICAgICAgICAgICdjb2RlJ1xuICAgICAgICAgICk7XG4gICAgICAgICAgcmV0dXJuIFtcbiAgICAgICAgICAgIG5ldyBQZXJtaXNzaW9uQWN0aW9ucy5Mb2FkUGVybWlzc2lvblN1Y2Nlc3ModmFsdWVzKSxcbiAgICAgICAgICAgIG5ldyBQZXJtaXNzaW9uQWN0aW9ucy5Mb2FkUGVybWlzc2lvbnNTdWNjZXNzKHtcbiAgICAgICAgICAgICAgcGFnZSxcbiAgICAgICAgICAgICAgcGFyYW1zOiBwYXlsb2FkLnBhcmFtcyxcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgIF07XG4gICAgICAgIH0pLFxuICAgICAgICBjYXRjaEVycm9yKChlcnJvcjogSHR0cEVycm9yUmVzcG9uc2UpID0+XG4gICAgICAgICAgb2YoXG4gICAgICAgICAgICBuZXcgUGVybWlzc2lvbkFjdGlvbnMuTG9hZFBlcm1pc3Npb25zRmFpbCh7XG4gICAgICAgICAgICAgIHBhcmFtczogcGF5bG9hZC5wYXJhbXMsXG4gICAgICAgICAgICAgIGVycm9yOiBub3JtYWxpemVIdHRwRXJyb3IoZXJyb3IpLFxuICAgICAgICAgICAgfSlcbiAgICAgICAgICApXG4gICAgICAgIClcbiAgICAgIClcbiAgICApXG4gICk7XG5cbiAgQEVmZmVjdCgpXG4gIGNyZWF0ZVBlcm1pc3Npb24kOiBPYnNlcnZhYmxlPFxuICAgIHwgUGVybWlzc2lvbkFjdGlvbnMuQ3JlYXRlUGVybWlzc2lvblN1Y2Nlc3NcbiAgICB8IFBlcm1pc3Npb25BY3Rpb25zLkNyZWF0ZVBlcm1pc3Npb25GYWlsXG4gICAgfCBPcmdhbml6YXRpb25BY3Rpb25zLk9yZ2FuaXphdGlvbkNsZWFyRGF0YVxuICA+ID0gdGhpcy5hY3Rpb25zJC5waXBlKFxuICAgIG9mVHlwZShQZXJtaXNzaW9uQWN0aW9ucy5DUkVBVEVfUEVSTUlTU0lPTiksXG4gICAgbWFwKChhY3Rpb246IFBlcm1pc3Npb25BY3Rpb25zLkNyZWF0ZVBlcm1pc3Npb24pID0+IGFjdGlvbi5wYXlsb2FkKSxcbiAgICBzd2l0Y2hNYXAoKHBheWxvYWQpID0+XG4gICAgICB0aGlzLnBlcm1pc3Npb25Db25uZWN0b3IuY3JlYXRlKHBheWxvYWQudXNlcklkLCBwYXlsb2FkLnBlcm1pc3Npb24pLnBpcGUoXG4gICAgICAgIHN3aXRjaE1hcCgoZGF0YSkgPT4gW1xuICAgICAgICAgIG5ldyBQZXJtaXNzaW9uQWN0aW9ucy5DcmVhdGVQZXJtaXNzaW9uU3VjY2VzcyhkYXRhKSxcbiAgICAgICAgICBuZXcgT3JnYW5pemF0aW9uQWN0aW9ucy5Pcmdhbml6YXRpb25DbGVhckRhdGEoKSxcbiAgICAgICAgXSksXG4gICAgICAgIGNhdGNoRXJyb3IoKGVycm9yOiBIdHRwRXJyb3JSZXNwb25zZSkgPT5cbiAgICAgICAgICBmcm9tKFtcbiAgICAgICAgICAgIG5ldyBQZXJtaXNzaW9uQWN0aW9ucy5DcmVhdGVQZXJtaXNzaW9uRmFpbCh7XG4gICAgICAgICAgICAgIHBlcm1pc3Npb25Db2RlOiBwYXlsb2FkLnBlcm1pc3Npb24uY29kZSxcbiAgICAgICAgICAgICAgZXJyb3I6IG5vcm1hbGl6ZUh0dHBFcnJvcihlcnJvciksXG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIG5ldyBPcmdhbml6YXRpb25BY3Rpb25zLk9yZ2FuaXphdGlvbkNsZWFyRGF0YSgpLFxuICAgICAgICAgIF0pXG4gICAgICAgIClcbiAgICAgIClcbiAgICApXG4gICk7XG5cbiAgQEVmZmVjdCgpXG4gIHVwZGF0ZVBlcm1pc3Npb24kOiBPYnNlcnZhYmxlPFxuICAgIHwgUGVybWlzc2lvbkFjdGlvbnMuVXBkYXRlUGVybWlzc2lvblN1Y2Nlc3NcbiAgICB8IFBlcm1pc3Npb25BY3Rpb25zLlVwZGF0ZVBlcm1pc3Npb25GYWlsXG4gICAgfCBPcmdhbml6YXRpb25BY3Rpb25zLk9yZ2FuaXphdGlvbkNsZWFyRGF0YVxuICA+ID0gdGhpcy5hY3Rpb25zJC5waXBlKFxuICAgIG9mVHlwZShQZXJtaXNzaW9uQWN0aW9ucy5VUERBVEVfUEVSTUlTU0lPTiksXG4gICAgbWFwKChhY3Rpb246IFBlcm1pc3Npb25BY3Rpb25zLlVwZGF0ZVBlcm1pc3Npb24pID0+IGFjdGlvbi5wYXlsb2FkKSxcbiAgICBzd2l0Y2hNYXAoKHBheWxvYWQpID0+XG4gICAgICB0aGlzLnBlcm1pc3Npb25Db25uZWN0b3JcbiAgICAgICAgLnVwZGF0ZShwYXlsb2FkLnVzZXJJZCwgcGF5bG9hZC5wZXJtaXNzaW9uQ29kZSwgcGF5bG9hZC5wZXJtaXNzaW9uKVxuICAgICAgICAucGlwZShcbiAgICAgICAgICBzd2l0Y2hNYXAoKGRhdGEpID0+IFtcbiAgICAgICAgICAgIG5ldyBQZXJtaXNzaW9uQWN0aW9ucy5VcGRhdGVQZXJtaXNzaW9uU3VjY2VzcyhkYXRhKSxcbiAgICAgICAgICAgIG5ldyBPcmdhbml6YXRpb25BY3Rpb25zLk9yZ2FuaXphdGlvbkNsZWFyRGF0YSgpLFxuICAgICAgICAgIF0pLFxuICAgICAgICAgIGNhdGNoRXJyb3IoKGVycm9yOiBIdHRwRXJyb3JSZXNwb25zZSkgPT5cbiAgICAgICAgICAgIGZyb20oW1xuICAgICAgICAgICAgICBuZXcgUGVybWlzc2lvbkFjdGlvbnMuVXBkYXRlUGVybWlzc2lvbkZhaWwoe1xuICAgICAgICAgICAgICAgIHBlcm1pc3Npb25Db2RlOiBwYXlsb2FkLnBlcm1pc3Npb24uY29kZSxcbiAgICAgICAgICAgICAgICBlcnJvcjogbm9ybWFsaXplSHR0cEVycm9yKGVycm9yKSxcbiAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgIG5ldyBPcmdhbml6YXRpb25BY3Rpb25zLk9yZ2FuaXphdGlvbkNsZWFyRGF0YSgpLFxuICAgICAgICAgICAgXSlcbiAgICAgICAgICApXG4gICAgICAgIClcbiAgICApXG4gICk7XG5cbiAgQEVmZmVjdCgpXG4gIGxvYWRQZXJtaXNzaW9uVHlwZXMkOiBPYnNlcnZhYmxlPFxuICAgIHwgUGVybWlzc2lvbkFjdGlvbnMuTG9hZFBlcm1pc3Npb25UeXBlc1N1Y2Nlc3NcbiAgICB8IFBlcm1pc3Npb25BY3Rpb25zLkxvYWRQZXJtaXNzaW9uVHlwZXNGYWlsXG4gID4gPSB0aGlzLmFjdGlvbnMkLnBpcGUoXG4gICAgb2ZUeXBlKFBlcm1pc3Npb25BY3Rpb25zLkxPQURfUEVSTUlTU0lPTl9UWVBFUyksXG4gICAgc3dpdGNoTWFwKCgpID0+XG4gICAgICB0aGlzLnBlcm1pc3Npb25Db25uZWN0b3IuZ2V0VHlwZXMoKS5waXBlKFxuICAgICAgICBtYXAoXG4gICAgICAgICAgKHBlcm1pc3Npb25UeXBlTGlzdDogT3JkZXJBcHByb3ZhbFBlcm1pc3Npb25UeXBlW10pID0+XG4gICAgICAgICAgICBuZXcgUGVybWlzc2lvbkFjdGlvbnMuTG9hZFBlcm1pc3Npb25UeXBlc1N1Y2Nlc3MocGVybWlzc2lvblR5cGVMaXN0KVxuICAgICAgICApLFxuICAgICAgICBjYXRjaEVycm9yKChlcnJvcjogSHR0cEVycm9yUmVzcG9uc2UpID0+XG4gICAgICAgICAgb2YoXG4gICAgICAgICAgICBuZXcgUGVybWlzc2lvbkFjdGlvbnMuTG9hZFBlcm1pc3Npb25UeXBlc0ZhaWwoe1xuICAgICAgICAgICAgICBlcnJvcjogbm9ybWFsaXplSHR0cEVycm9yKGVycm9yKSxcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgKVxuICAgICAgICApXG4gICAgICApXG4gICAgKVxuICApO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgYWN0aW9ucyQ6IEFjdGlvbnMsXG4gICAgcHJpdmF0ZSBwZXJtaXNzaW9uQ29ubmVjdG9yOiBQZXJtaXNzaW9uQ29ubmVjdG9yXG4gICkge31cbn1cbiJdfQ==