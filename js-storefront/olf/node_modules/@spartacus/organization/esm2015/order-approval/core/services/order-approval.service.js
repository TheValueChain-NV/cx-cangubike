import { Injectable } from '@angular/core';
import { select } from '@ngrx/store';
import { ProcessSelectors, } from '@spartacus/core';
import { queueScheduler } from 'rxjs';
import { filter, map, observeOn, pluck, tap } from 'rxjs/operators';
import { OrderApprovalActions } from '../store/actions/index';
import { ORDER_APPROVAL_MAKE_DECISION_PROCESS_ID, } from '../store/order-approval-state';
import { OrderApprovalSelectors } from '../store/selectors';
import * as i0 from "@angular/core";
import * as i1 from "@ngrx/store";
import * as i2 from "@spartacus/core";
export class OrderApprovalService {
    constructor(store, userIdService) {
        this.store = store;
        this.userIdService = userIdService;
    }
    loadOrderApproval(orderApprovalCode) {
        this.userIdService.takeUserId().subscribe((userId) => this.store.dispatch(new OrderApprovalActions.LoadOrderApproval({
            userId,
            orderApprovalCode,
        })));
    }
    loadOrderApprovals(params) {
        this.userIdService
            .takeUserId()
            .subscribe((userId) => this.store.dispatch(new OrderApprovalActions.LoadOrderApprovals({ userId, params })));
    }
    getOrderApproval(orderApprovalCode) {
        return this.store.select(OrderApprovalSelectors.getOrderApproval(orderApprovalCode));
    }
    getOrderApprovalList(params) {
        return this.store.select(OrderApprovalSelectors.getOrderApprovalList(params));
    }
    get(orderApprovalCode) {
        return this.getOrderApproval(orderApprovalCode).pipe(observeOn(queueScheduler), tap((state) => {
            if (!(state.loading || state.success || state.error)) {
                this.loadOrderApproval(orderApprovalCode);
            }
        }), filter((state) => state.success || state.error), map((state) => state.value));
    }
    /**
     * Emits true if a request is currently fetching order approval data from
     * the server.
     *
     * @param orderApprovalCode The approval code for which we want the loading status.
     */
    getOrderApprovalLoading(orderApprovalCode) {
        return this.getOrderApproval(orderApprovalCode).pipe(pluck('loading'));
    }
    getList(params) {
        return this.getOrderApprovalList(params).pipe(observeOn(queueScheduler), tap((process) => {
            if (!(process.loading || process.success || process.error)) {
                this.loadOrderApprovals(params);
            }
        }), filter((process) => process.success || process.error), map((result) => result.value));
    }
    makeDecision(orderApprovalCode, orderApprovalDecision) {
        this.userIdService.takeUserId().subscribe((userId) => this.store.dispatch(new OrderApprovalActions.MakeDecision({
            userId,
            orderApprovalCode,
            orderApprovalDecision,
        })));
    }
    /**
     * Returns the makeDecision loading flag.  Returns true when the process triggered
     * by makeDecision() is currently running.
     */
    getMakeDecisionResultLoading() {
        return this.store.pipe(select(ProcessSelectors.getProcessLoadingFactory(ORDER_APPROVAL_MAKE_DECISION_PROCESS_ID)));
    }
    /**
     * Returns the makeDecision failure outcome.  Returns true when the outcome
     * of makeDecision() was an error.
     */
    getMakeDecisionResultError() {
        return this.store.pipe(select(ProcessSelectors.getProcessErrorFactory(ORDER_APPROVAL_MAKE_DECISION_PROCESS_ID)));
    }
    /**
     * Returns the makeDecision process success outcome.  Returns true when the outcome
     * of makeDecision() was a success.
     */
    getMakeDecisionResultSuccess() {
        return this.store.pipe(select(ProcessSelectors.getProcessSuccessFactory(ORDER_APPROVAL_MAKE_DECISION_PROCESS_ID)));
    }
    /**
     * Resets the makeDecision process state. It is usually preferable to reset the
     * process state before making a call to makeDecision() for which we then want
     * to monitor the loading state or the outcome.
     */
    resetMakeDecisionProcessState() {
        this.store.dispatch(new OrderApprovalActions.MakeDecisionReset());
    }
}
OrderApprovalService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.0.5", ngImport: i0, type: OrderApprovalService, deps: [{ token: i1.Store }, { token: i2.UserIdService }], target: i0.ɵɵFactoryTarget.Injectable });
OrderApprovalService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "12.0.5", ngImport: i0, type: OrderApprovalService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.0.5", ngImport: i0, type: OrderApprovalService, decorators: [{
            type: Injectable,
            args: [{ providedIn: 'root' }]
        }], ctorParameters: function () { return [{ type: i1.Store }, { type: i2.UserIdService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3JkZXItYXBwcm92YWwuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL2ZlYXR1cmUtbGlicy9vcmdhbml6YXRpb24vb3JkZXItYXBwcm92YWwvY29yZS9zZXJ2aWNlcy9vcmRlci1hcHByb3ZhbC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLE1BQU0sRUFBUyxNQUFNLGFBQWEsQ0FBQztBQUM1QyxPQUFPLEVBRUwsZ0JBQWdCLEdBS2pCLE1BQU0saUJBQWlCLENBQUM7QUFDekIsT0FBTyxFQUFjLGNBQWMsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNsRCxPQUFPLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBS3BFLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQzlELE9BQU8sRUFFTCx1Q0FBdUMsR0FDeEMsTUFBTSwrQkFBK0IsQ0FBQztBQUN2QyxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQzs7OztBQUc1RCxNQUFNLE9BQU8sb0JBQW9CO0lBQy9CLFlBQ1ksS0FBeUQsRUFDekQsYUFBNEI7UUFENUIsVUFBSyxHQUFMLEtBQUssQ0FBb0Q7UUFDekQsa0JBQWEsR0FBYixhQUFhLENBQWU7SUFDckMsQ0FBQztJQUVKLGlCQUFpQixDQUFDLGlCQUF5QjtRQUN6QyxJQUFJLENBQUMsYUFBYSxDQUFDLFVBQVUsRUFBRSxDQUFDLFNBQVMsQ0FBQyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQ25ELElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUNqQixJQUFJLG9CQUFvQixDQUFDLGlCQUFpQixDQUFDO1lBQ3pDLE1BQU07WUFDTixpQkFBaUI7U0FDbEIsQ0FB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QixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUNwQixNQUFNLENBQ0osZ0JBQWdCLENBQUMsd0JBQXdCLENBQ3ZDLHVDQUF1QyxDQUN4QyxDQUNGLENBQ0YsQ0FBQztJQUNKLENBQUM7SUFFRDs7O09BR0c7SUFDSCwwQkFBMEI7UUFDeEIsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FDcEIsTUFBTSxDQUNKLGdCQUFnQixDQUFDLHNCQUFzQixDQUNyQyx1Q0FBdUMsQ0FDeEMsQ0FDRixDQUNGLENBQUM7SUFDSixDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsNEJBQTRCO1FBQzFCLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQ3BCLE1BQU0sQ0FDSixnQkFBZ0IsQ0FBQyx3QkFBd0IsQ0FDdkMsdUNBQXVDLENBQ3hDLENBQ0YsQ0FDRixDQUFDO0lBQ0osQ0FBQztJQUVEOzs7O09BSUc7SUFDSCw2QkFBNkI7UUFDM0IsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsSUFBSSxvQkFBb0IsQ0FBQyxpQkFBaUIsRUFBRSxDQUFDLENBQUM7SUFDcEUsQ0FBQzs7aUhBbEpVLG9CQUFvQjtxSEFBcEIsb0JBQW9CLGNBRFAsTUFBTTsyRkFDbkIsb0JBQW9CO2tCQURoQyxVQUFVO21CQUFDLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IHNlbGVjdCwgU3RvcmUgfSBmcm9tICdAbmdyeC9zdG9yZSc7XG5pbXBvcnQge1xuICBFbnRpdGllc01vZGVsLFxuICBQcm9jZXNzU2VsZWN0b3JzLFxuICBTZWFyY2hDb25maWcsXG4gIFN0YXRlVXRpbHMsXG4gIFN0YXRlV2l0aFByb2Nlc3MsXG4gIFVzZXJJZFNlcnZpY2UsXG59IGZyb20gJ0BzcGFydGFjdXMvY29yZSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBxdWV1ZVNjaGVkdWxlciB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZmlsdGVyLCBtYXAsIG9ic2VydmVPbiwgcGx1Y2ssIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7XG4gIE9yZGVyQXBwcm92YWwsXG4gIE9yZGVyQXBwcm92YWxEZWNpc2lvbixcbn0gZnJvbSAnLi4vbW9kZWwvb3JkZXItYXBwcm92YWwubW9kZWwnO1xuaW1wb3J0IHsgT3JkZXJBcHByb3ZhbEFjdGlvbnMgfSBmcm9tICcuLi9zdG9yZS9hY3Rpb25zL2luZGV4JztcbmltcG9ydCB7XG4gIE9yZGVyQXBwcm92YWxTdGF0ZSxcbiAgT1JERVJfQVBQUk9WQUxfTUFLRV9ERUNJU0lPTl9QUk9DRVNTX0lELFxufSBmcm9tICcuLi9zdG9yZS9vcmRlci1hcHByb3ZhbC1zdGF0ZSc7XG5pbXBvcnQgeyBPcmRlckFwcHJvdmFsU2VsZWN0b3JzIH0gZnJvbSAnLi4vc3RvcmUvc2VsZWN0b3JzJztcblxuQEluamVjdGFibGUoeyBwcm92aWRlZEluOiAncm9vdCcgfSlcbmV4cG9ydCBjbGFzcyBPcmRlckFwcHJvdmFsU2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByb3RlY3RlZCBzdG9yZTogU3RvcmU8T3JkZXJBcHByb3ZhbFN0YXRlIHwgU3RhdGVXaXRoUHJvY2Vzczx2b2lkPj4sXG4gICAgcHJvdGVjdGVkIHVzZXJJZFNlcnZpY2U6IFVzZXJJZFNlcnZpY2VcbiAgKSB7fVxuXG4gIGxvYWRPcmRlckFwcHJvdmFsKG9yZGVyQXBwcm92YWxDb2RlOiBzdHJpbmcpOiB2b2lkIHtcbiAgICB0aGlzLnVzZXJJZFNlcnZpY2UudGFrZVVzZXJJZCgpLnN1YnNjcmliZSgodXNlcklkKSA9PlxuICAgICAgdGhpcy5zdG9yZS5kaXNwYXRjaChcbiAgICAgICAgbmV3IE9yZGVyQXBwcm92YWxBY3Rpb25zLkxvYWRPcmRlckFwcHJvdmFsKHtcbiAgICAgICAgICB1c2VySWQsXG4gICAgICAgICAgb3JkZXJBcHByb3ZhbENvZGUsXG4gICAgICAgIH0pXG4gICAgICApXG4gICAgKTtcbiAgfVxuXG4gIGxvYWRPcmRlckFwcHJvdmFscyhwYXJhbXM/OiBTZWFyY2hDb25maWcpOiB2b2lkIHtcbiAgICB0aGlzLnVzZXJJZFNlcnZpY2VcbiAgICAgIC50YWtlVXNlcklkKClcbiAgICAgIC5zdWJzY3JpYmUoKHVzZXJJZCkgPT5cbiAgICAgICAgdGhpcy5zdG9yZS5kaXNwYXRjaChcbiAgICAgICAgICBuZXcgT3JkZXJBcHByb3ZhbEFjdGlvbnMuTG9hZE9yZGVyQXBwcm92YWxzKHsgdXNlcklkLCBwYXJhbXMgfSlcbiAgICAgICAgKVxuICAgICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0T3JkZXJBcHByb3ZhbChcbiAgICBvcmRlckFwcHJvdmFsQ29kZTogc3RyaW5nXG4gICk6IE9ic2VydmFibGU8U3RhdGVVdGlscy5Mb2FkZXJTdGF0ZTxPcmRlckFwcHJvdmFsPj4ge1xuICAgIHJldHVybiB0aGlzLnN0b3JlLnNlbGVjdChcbiAgICAgIE9yZGVyQXBwcm92YWxTZWxlY3RvcnMuZ2V0T3JkZXJBcHByb3ZhbChvcmRlckFwcHJvdmFsQ29kZSlcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRPcmRlckFwcHJvdmFsTGlzdChcbiAgICBwYXJhbXNcbiAgKTogT2JzZXJ2YWJsZTxTdGF0ZVV0aWxzLkxvYWRlclN0YXRlPEVudGl0aWVzTW9kZWw8T3JkZXJBcHByb3ZhbD4+PiB7XG4gICAgcmV0dXJuIHRoaXMuc3RvcmUuc2VsZWN0KFxuICAgICAgT3JkZXJBcHByb3ZhbFNlbGVjdG9ycy5nZXRPcmRlckFwcHJvdmFsTGlzdChwYXJhbXMpXG4gICAgKTtcbiAgfVxuXG4gIGdldChvcmRlckFwcHJvdmFsQ29kZTogc3RyaW5nKTogT2JzZXJ2YWJsZTxPcmRlckFwcHJvdmFsPiB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0T3JkZXJBcHByb3ZhbChvcmRlckFwcHJvdmFsQ29kZSkucGlwZShcbiAgICAgIG9ic2VydmVPbihxdWV1ZVNjaGVkdWxlciksXG4gICAgICB0YXAoKHN0YXRlKSA9PiB7XG4gICAgICAgIGlmICghKHN0YXRlLmxvYWRpbmcgfHwgc3RhdGUuc3VjY2VzcyB8fCBzdGF0ZS5lcnJvcikpIHtcbiAgICAgICAgICB0aGlzLmxvYWRPcmRlckFwcHJvdmFsKG9yZGVyQXBwcm92YWxDb2RlKTtcbiAgICAgICAgfVxuICAgICAgfSksXG4gICAgICBmaWx0ZXIoKHN0YXRlKSA9PiBzdGF0ZS5zdWNjZXNzIHx8IHN0YXRlLmVycm9yKSxcbiAgICAgIG1hcCgoc3RhdGUpID0+IHN0YXRlLnZhbHVlKVxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogRW1pdHMgdHJ1ZSBpZiBhIHJlcXVlc3QgaXMgY3VycmVudGx5IGZldGNoaW5nIG9yZGVyIGFwcHJvdmFsIGRhdGEgZnJvbVxuICAgKiB0aGUgc2VydmVyLlxuICAgKlxuICAgKiBAcGFyYW0gb3JkZXJBcHByb3ZhbENvZGUgVGhlIGFwcHJvdmFsIGNvZGUgZm9yIHdoaWNoIHdlIHdhbnQgdGhlIGxvYWRpbmcgc3RhdHVzLlxuICAgKi9cbiAgZ2V0T3JkZXJBcHByb3ZhbExvYWRpbmcob3JkZXJBcHByb3ZhbENvZGU6IHN0cmluZyk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgIHJldHVybiB0aGlzLmdldE9yZGVyQXBwcm92YWwob3JkZXJBcHByb3ZhbENvZGUpLnBpcGUocGx1Y2soJ2xvYWRpbmcnKSk7XG4gIH1cblxuICBnZXRMaXN0KHBhcmFtczogU2VhcmNoQ29uZmlnKTogT2JzZXJ2YWJsZTxFbnRpdGllc01vZGVsPE9yZGVyQXBwcm92YWw+PiB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0T3JkZXJBcHByb3ZhbExpc3QocGFyYW1zKS5waXBlKFxuICAgICAgb2JzZXJ2ZU9uKHF1ZXVlU2NoZWR1bGVyKSxcbiAgICAgIHRhcCgocHJvY2VzczogU3RhdGVVdGlscy5Mb2FkZXJTdGF0ZTxFbnRpdGllc01vZGVsPE9yZGVyQXBwcm92YWw+PikgPT4ge1xuICAgICAgICBpZiAoIShwcm9jZXNzLmxvYWRpbmcgfHwgcHJvY2Vzcy5zdWNjZXNzIHx8IHByb2Nlc3MuZXJyb3IpKSB7XG4gICAgICAgICAgdGhpcy5sb2FkT3JkZXJBcHByb3ZhbHMocGFyYW1zKTtcbiAgICAgICAgfVxuICAgICAgfSksXG4gICAgICBmaWx0ZXIoXG4gICAgICAgIChwcm9jZXNzOiBTdGF0ZVV0aWxzLkxvYWRlclN0YXRlPEVudGl0aWVzTW9kZWw8T3JkZXJBcHByb3ZhbD4+KSA9PlxuICAgICAgICAgIHByb2Nlc3Muc3VjY2VzcyB8fCBwcm9jZXNzLmVycm9yXG4gICAgICApLFxuICAgICAgbWFwKChyZXN1bHQpID0+IHJlc3VsdC52YWx1ZSlcbiAgICApO1xuICB9XG5cbiAgbWFrZURlY2lzaW9uKFxuICAgIG9yZGVyQXBwcm92YWxDb2RlOiBzdHJpbmcsXG4gICAgb3JkZXJBcHByb3ZhbERlY2lzaW9uOiBPcmRlckFwcHJvdmFsRGVjaXNpb25cbiAgKTogdm9pZCB7XG4gICAgdGhpcy51c2VySWRTZXJ2aWNlLnRha2VVc2VySWQoKS5zdWJzY3JpYmUoKHVzZXJJZCkgPT5cbiAgICAgIHRoaXMuc3RvcmUuZGlzcGF0Y2goXG4gICAgICAgIG5ldyBPcmRlckFwcHJvdmFsQWN0aW9ucy5NYWtlRGVjaXNpb24oe1xuICAgICAgICAgIHVzZXJJZCxcbiAgICAgICAgICBvcmRlckFwcHJvdmFsQ29kZSxcbiAgICAgICAgICBvcmRlckFwcHJvdmFsRGVjaXNpb24sXG4gICAgICAgIH0pXG4gICAgICApXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHRoZSBtYWtlRGVjaXNpb24gbG9hZGluZyBmbGFnLiAgUmV0dXJucyB0cnVlIHdoZW4gdGhlIHByb2Nlc3MgdHJpZ2dlcmVkXG4gICAqIGJ5IG1ha2VEZWNpc2lvbigpIGlzIGN1cnJlbnRseSBydW5uaW5nLlxuICAgKi9cbiAgZ2V0TWFrZURlY2lzaW9uUmVzdWx0TG9hZGluZygpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcbiAgICByZXR1cm4gdGhpcy5zdG9yZS5waXBlKFxuICAgICAgc2VsZWN0KFxuICAgICAgICBQcm9jZXNzU2VsZWN0b3JzLmdldFByb2Nlc3NMb2FkaW5nRmFjdG9yeShcbiAgICAgICAgICBPUkRFUl9BUFBST1ZBTF9NQUtFX0RFQ0lTSU9OX1BST0NFU1NfSURcbiAgICAgICAgKVxuICAgICAgKVxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgbWFrZURlY2lzaW9uIGZhaWx1cmUgb3V0Y29tZS4gIFJldHVybnMgdHJ1ZSB3aGVuIHRoZSBvdXRjb21lXG4gICAqIG9mIG1ha2VEZWNpc2lvbigpIHdhcyBhbiBlcnJvci5cbiAgICovXG4gIGdldE1ha2VEZWNpc2lvblJlc3VsdEVycm9yKCk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgIHJldHVybiB0aGlzLnN0b3JlLnBpcGUoXG4gICAgICBzZWxlY3QoXG4gICAgICAgIFByb2Nlc3NTZWxlY3RvcnMuZ2V0UHJvY2Vzc0Vycm9yRmFjdG9yeShcbiAgICAgICAgICBPUkRFUl9BUFBST1ZBTF9NQUtFX0RFQ0lTSU9OX1BST0NFU1NfSURcbiAgICAgICAgKVxuICAgICAgKVxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgbWFrZURlY2lzaW9uIHByb2Nlc3Mgc3VjY2VzcyBvdXRjb21lLiAgUmV0dXJucyB0cnVlIHdoZW4gdGhlIG91dGNvbWVcbiAgICogb2YgbWFrZURlY2lzaW9uKCkgd2FzIGEgc3VjY2Vzcy5cbiAgICovXG4gIGdldE1ha2VEZWNpc2lvblJlc3VsdFN1Y2Nlc3MoKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XG4gICAgcmV0dXJuIHRoaXMuc3RvcmUucGlwZShcbiAgICAgIHNlbGVjdChcbiAgICAgICAgUHJvY2Vzc1NlbGVjdG9ycy5nZXRQcm9jZXNzU3VjY2Vzc0ZhY3RvcnkoXG4gICAgICAgICAgT1JERVJfQVBQUk9WQUxfTUFLRV9ERUNJU0lPTl9QUk9DRVNTX0lEXG4gICAgICAgIClcbiAgICAgIClcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlc2V0cyB0aGUgbWFrZURlY2lzaW9uIHByb2Nlc3Mgc3RhdGUuIEl0IGlzIHVzdWFsbHkgcHJlZmVyYWJsZSB0byByZXNldCB0aGVcbiAgICogcHJvY2VzcyBzdGF0ZSBiZWZvcmUgbWFraW5nIGEgY2FsbCB0byBtYWtlRGVjaXNpb24oKSBmb3Igd2hpY2ggd2UgdGhlbiB3YW50XG4gICAqIHRvIG1vbml0b3IgdGhlIGxvYWRpbmcgc3RhdGUgb3IgdGhlIG91dGNvbWUuXG4gICAqL1xuICByZXNldE1ha2VEZWNpc2lvblByb2Nlc3NTdGF0ZSgpOiB2b2lkIHtcbiAgICB0aGlzLnN0b3JlLmRpc3BhdGNoKG5ldyBPcmRlckFwcHJvdmFsQWN0aW9ucy5NYWtlRGVjaXNpb25SZXNldCgpKTtcbiAgfVxufVxuIl19